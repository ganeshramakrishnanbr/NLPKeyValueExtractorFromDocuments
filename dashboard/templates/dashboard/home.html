{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="row">
    <!-- Sidebar -->
    <div class="col-lg-3 mb-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-cogs me-2"></i>Processing Options</h5>
            </div>
            <div class="card-body">
                <!-- Mode Selection -->
                <div class="mb-4">
                    <label class="form-label fw-bold">Extraction Mode</label>
                    <div class="btn-group-vertical d-grid gap-2" role="group">
                        <input type="radio" class="btn-check" name="mode" id="presetMode" value="preset" checked>
                        <label class="btn btn-outline-primary text-start" for="presetMode">
                            <i class="fas fa-list me-2"></i>Standard Fields
                            <small class="d-block text-muted">Quick preset extraction</small>
                        </label>

                        <input type="radio" class="btn-check" name="mode" id="customMode" value="custom">
                        <label class="btn btn-outline-primary text-start" for="customMode">
                            <i class="fas fa-edit me-2"></i>Custom Fields
                            <small class="d-block text-muted">Specify your own fields</small>
                        </label>

                        <input type="radio" class="btn-check" name="mode" id="multiTechniqueMode" value="multi-technique">
                        <label class="btn btn-outline-primary text-start" for="multiTechniqueMode">
                            <i class="fas fa-chart-line me-2"></i>Multi-Technique
                            <small class="d-block text-muted">Comparative analysis</small>
                        </label>
                    </div>
                </div>

                <!-- Custom Fields Section -->
                <div id="customFieldsSection" class="mb-4" style="display: none;">
                    <label class="form-label fw-bold">Custom Fields</label>
                    <textarea id="customFields" class="form-control" rows="3" 
                        placeholder="Enter fields separated by commas&#10;e.g., name, email, company, date"></textarea>
                    <small class="text-muted">Specify which fields to extract from your document</small>
                </div>

                <!-- Multi-Technique Section -->
                <div id="multiTechniqueSection" class="mb-4" style="display: none;">
                    <label class="form-label fw-bold">Select Techniques</label>
                    <div class="technique-selection">
                        <div class="mb-3">
                            <button type="button" class="btn btn-sm btn-success me-2" onclick="selectRecommendedTechniques()">
                                <i class="fas fa-star me-1"></i>Recommended
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary me-2" onclick="selectAllTechniques()">
                                Select All
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearAllTechniques()">
                                Clear All
                            </button>
                        </div>
                        
                        <div class="technique-list">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" name="technique" value="regex_pattern_matching" id="tech1" checked>
                                <label class="form-check-label" for="tech1">
                                    <strong>Regex Pattern Matching</strong>
                                    <small class="d-block text-muted">Structured data identification</small>
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" name="technique" value="fuzzy_string_matching" id="tech2" checked>
                                <label class="form-check-label" for="tech2">
                                    <strong>Fuzzy String Matching</strong>
                                    <small class="d-block text-muted">Keyword proximity analysis</small>
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" name="technique" value="keyword_proximity_analysis" id="tech3" checked>
                                <label class="form-check-label" for="tech3">
                                    <strong>Keyword Proximity</strong>
                                    <small class="d-block text-muted">Distance-based extraction</small>
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" name="technique" value="context_aware_extraction" id="tech4">
                                <label class="form-check-label" for="tech4">
                                    <strong>Context-Aware</strong>
                                    <small class="d-block text-muted">Semantic context analysis</small>
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" name="technique" value="template_based_extraction" id="tech5">
                                <label class="form-check-label" for="tech5">
                                    <strong>Template-Based</strong>
                                    <small class="d-block text-muted">Document structure patterns</small>
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" name="technique" value="confidence_weighted_extraction" id="tech6" checked>
                                <label class="form-check-label" for="tech6">
                                    <strong>Confidence-Weighted</strong>
                                    <small class="d-block text-muted">Machine learning enhanced</small>
                                </label>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <label class="form-label">Fields for Analysis</label>
                            <input type="text" id="multiTechniqueFields" class="form-control" 
                                placeholder="name, email, company (optional)">
                        </div>
                    </div>
                </div>

                <!-- Features List -->
                <div class="mb-4">
                    <h6 class="fw-bold">Features</h6>
                    {% for feature in features %}
                    <div class="d-flex align-items-center mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        <small>{{ feature }}</small>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="col-lg-9">
        <!-- Upload Section -->
        <div id="uploadSection" class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-gradient-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-cloud-upload-alt me-2"></i>
                    Document Upload & Processing
                </h5>
            </div>
            <div class="card-body text-center py-5">
                <div class="upload-zone border-3 border-dashed border-primary rounded-3 p-5 mb-4" 
                     ondrop="dropHandler(event)" ondragover="dragOverHandler(event)" ondragleave="dragLeaveHandler(event)">
                    <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                    <h4 class="text-primary mb-3">Drag & Drop Your Document</h4>
                    <p class="text-muted mb-4">or click to browse files</p>
                    
                    <input type="file" id="fileInput" class="d-none" accept=".pdf,.docx,.doc,.md">
                    <button class="btn btn-primary btn-lg" onclick="document.getElementById('fileInput').click()">
                        <i class="fas fa-folder-open me-2"></i>Choose File
                    </button>
                    
                    <div class="mt-4">
                        <p class="mb-2"><strong>Supported formats:</strong></p>
                        {% for format in supported_formats %}
                        <span class="badge bg-secondary me-2">{{ format }}</span>
                        {% endfor %}
                    </div>
                </div>

                <div id="fileInfo" class="alert alert-info" style="display: none;">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-file-alt fa-2x me-3"></i>
                        <div>
                            <h6 class="mb-1" id="fileName"></h6>
                            <small class="text-muted" id="fileSize"></small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading Section -->
        <div id="loading" class="card border-0 shadow-sm mb-4" style="display: none;">
            <div class="card-body text-center py-5">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h5 class="mb-3">Processing Your Document</h5>
                <p class="text-muted">This may take a few moments depending on document complexity...</p>
                
                <!-- Progress container will be dynamically added here for multi-technique -->
                <div id="progressContainer"></div>
            </div>
        </div>

        <!-- Error Section -->
        <div id="error" class="alert alert-danger" style="display: none;" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <span id="errorMessage"></span>
        </div>

        <!-- Results Section -->
        <div id="results" class="row" style="display: none;">
            <!-- Results will be dynamically populated here -->
        </div>

        <!-- Statistics Dashboard -->
        <div class="row mt-4">
            <div class="col-md-3">
                <div class="card text-center border-0 shadow-sm">
                    <div class="card-body">
                        <i class="fas fa-file-upload fa-2x text-primary mb-2"></i>
                        <h3 class="mb-1" id="uploadCount">0</h3>
                        <small class="text-muted">Documents Processed</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center border-0 shadow-sm">
                    <div class="card-body">
                        <i class="fas fa-percentage fa-2x text-success mb-2"></i>
                        <h3 class="mb-1" id="avgConfidence">95%</h3>
                        <small class="text-muted">Avg Confidence</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center border-0 shadow-sm">
                    <div class="card-body">
                        <i class="fas fa-clock fa-2x text-info mb-2"></i>
                        <h3 class="mb-1" id="avgTime">2.3s</h3>
                        <small class="text-muted">Avg Processing Time</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center border-0 shadow-sm">
                    <div class="card-body">
                        <i class="fas fa-search fa-2x text-warning mb-2"></i>
                        <h3 class="mb-1" id="fieldCount">12</h3>
                        <small class="text-muted">Fields Extracted</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Dashboard JavaScript functionality
let currentMode = 'preset';
let processingStats = {
    uploadCount: 0,
    totalConfidence: 0,
    totalTime: 0,
    totalFields: 0
};

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    initializeEventListeners();
    updateStats();
});

function initializeEventListeners() {
    // Mode switching
    document.querySelectorAll('input[name="mode"]').forEach(radio => {
        radio.addEventListener('change', function() {
            switchMode(this.value);
        });
    });

    // File input
    document.getElementById('fileInput').addEventListener('change', handleFileSelect);

    // Drag and drop
    const uploadZone = document.querySelector('.upload-zone');
    uploadZone.addEventListener('click', () => document.getElementById('fileInput').click());
}

function switchMode(mode) {
    currentMode = mode;
    
    // Hide all sections
    document.getElementById('customFieldsSection').style.display = 'none';
    document.getElementById('multiTechniqueSection').style.display = 'none';
    
    // Show relevant section
    if (mode === 'custom') {
        document.getElementById('customFieldsSection').style.display = 'block';
    } else if (mode === 'multi-technique') {
        document.getElementById('multiTechniqueSection').style.display = 'block';
    }
}

function handleFileSelect(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    displayFileInfo(file);
    processDocument(file);
}

function displayFileInfo(file) {
    document.getElementById('fileName').textContent = file.name;
    document.getElementById('fileSize').textContent = formatFileSize(file.size);
    document.getElementById('fileInfo').style.display = 'block';
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

async function processDocument(file) {
    showLoading();
    hideError();
    
    const formData = new FormData();
    formData.append('file', file);
    
    let endpoint = '/upload/';
    
    try {
        if (currentMode === 'custom') {
            const fields = document.getElementById('customFields').value.trim();
            formData.append('fields', fields);
            endpoint = '/extract-custom/';
        } else if (currentMode === 'multi-technique') {
            const selectedTechniques = Array.from(document.querySelectorAll('input[name="technique"]:checked'))
                .map(cb => cb.value);
            
            if (selectedTechniques.length === 0) {
                throw new Error('Please select at least one extraction technique');
            }
            
            const fields = document.getElementById('multiTechniqueFields').value.trim();
            formData.append('selected_techniques', selectedTechniques.join(','));
            formData.append('fields', fields);
            endpoint = '/multi-technique/';
            
            // Show progressive loading for multi-technique
            await processWithProgress(formData, selectedTechniques);
            return;
        }
        
        const response = await fetch(endpoint, {
            method: 'POST',
            body: formData
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Processing failed');
        }
        
        const result = await response.json();
        displayResults(result);
        updateProcessingStats(result);
        
    } catch (error) {
        showError(error.message);
    } finally {
        hideLoading();
    }
}

function showLoading() {
    document.getElementById('loading').style.display = 'block';
    document.getElementById('uploadSection').style.display = 'none';
    document.getElementById('results').style.display = 'none';
}

function hideLoading() {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('uploadSection').style.display = 'block';
}

function showError(message) {
    document.getElementById('errorMessage').textContent = message;
    document.getElementById('error').style.display = 'block';
    hideLoading();
}

function hideError() {
    document.getElementById('error').style.display = 'none';
}

function displayResults(data) {
    const resultsContainer = document.getElementById('results');
    resultsContainer.innerHTML = '';
    
    if (currentMode === 'custom') {
        displayCustomResults(data, resultsContainer);
    } else {
        displayStandardResults(data, resultsContainer);
    }
    
    resultsContainer.style.display = 'block';
}

function updateProcessingStats(result) {
    processingStats.uploadCount++;
    processingStats.totalConfidence += result.confidence_score || 0.95;
    processingStats.totalTime += result.processing_time || 2.3;
    processingStats.totalFields += Object.keys(result.extracted_fields || result.customer_info || {}).length;
    
    updateStats();
}

function updateStats() {
    const count = processingStats.uploadCount;
    document.getElementById('uploadCount').textContent = count;
    
    if (count > 0) {
        const avgConf = Math.round((processingStats.totalConfidence / count) * 100);
        const avgTime = (processingStats.totalTime / count).toFixed(1);
        const avgFields = Math.round(processingStats.totalFields / count);
        
        document.getElementById('avgConfidence').textContent = avgConf + '%';
        document.getElementById('avgTime').textContent = avgTime + 's';
        document.getElementById('fieldCount').textContent = avgFields;
    }
}

// Drag and drop handlers
function dragOverHandler(event) {
    event.preventDefault();
    event.currentTarget.classList.add('border-success', 'bg-light');
}

function dragLeaveHandler(event) {
    event.currentTarget.classList.remove('border-success', 'bg-light');
}

function dropHandler(event) {
    event.preventDefault();
    event.currentTarget.classList.remove('border-success', 'bg-light');
    
    const files = event.dataTransfer.files;
    if (files.length > 0) {
        document.getElementById('fileInput').files = files;
        handleFileSelect({ target: { files: files } });
    }
}

// Technique selection functions
function selectRecommendedTechniques() {
    const recommended = ['regex_pattern_matching', 'fuzzy_string_matching', 'keyword_proximity_analysis', 'confidence_weighted_extraction'];
    document.querySelectorAll('input[name="technique"]').forEach(cb => {
        cb.checked = recommended.includes(cb.value);
    });
}

function selectAllTechniques() {
    document.querySelectorAll('input[name="technique"]').forEach(cb => cb.checked = true);
}

function clearAllTechniques() {
    document.querySelectorAll('input[name="technique"]').forEach(cb => cb.checked = false);
}

// Health check
async function checkHealth() {
    try {
        const response = await fetch('/api/health/');
        const data = await response.json();
        
        const message = `Status: ${data.status}\nFrontend: ${data.frontend}\nBackend: ${data.backend}`;
        alert(message);
    } catch (error) {
        alert('Health check failed: ' + error.message);
    }
}
</script>
{% endblock %}