<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }} - NLP Document Extraction Platform</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .feature-card {
            transition: transform 0.2s;
            border: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        .upload-area {
            border: 2px dashed #007bff;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }
        .upload-area:hover {
            border-color: #0056b3;
            background-color: #f8f9fa;
        }
        .upload-area.dragover {
            border-color: #28a745;
            background-color: #d4edda;
        }
        .hero-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 60px 0;
        }
        .api-status {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <!-- API Status Indicator -->
    <div class="api-status">
        <div class="badge bg-success" id="api-status">
            <i class="fas fa-circle me-1"></i>Enhanced API Online
        </div>
    </div>

    <!-- Hero Section -->
    <div class="hero-section">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 mx-auto text-center">
                    <h1 class="display-4 fw-bold mb-4">{{ title }}</h1>
                    <p class="lead mb-4">{{ description }}</p>
                    <div class="row">
                        <div class="col-md-6">
                            <h5><i class="fas fa-file-alt me-2"></i>Supported Formats</h5>
                            <div class="d-flex justify-content-center flex-wrap gap-2 mt-2">
                                {% for format in supported_formats %}
                                <span class="badge bg-light text-dark">{{ format }}</span>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h5><i class="fas fa-cogs me-2"></i>Advanced Features</h5>
                            <div class="text-start">
                                <small>• Table extraction • Quality assessment</small><br>
                                <small>• Batch processing • Multi-format support</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container my-5">
        <!-- Processing Mode Selection -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0"><i class="fas fa-cogs me-2"></i>Processing Mode</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="processing-mode" id="standard-mode" value="standard" checked>
                                    <label class="form-check-label" for="standard-mode">
                                        <strong>Standard Processing</strong><br>
                                        <small class="text-muted">Basic field extraction (Name, SSN, DOB, etc.)</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="processing-mode" id="custom-mode" value="custom">
                                    <label class="form-check-label" for="custom-mode">
                                        <strong>Custom Fields</strong><br>
                                        <small class="text-muted">Extract user-defined fields</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="processing-mode" id="multi-technique-mode" value="multi-technique">
                                    <label class="form-check-label" for="multi-technique-mode">
                                        <strong>Multi-Technique Analysis</strong><br>
                                        <small class="text-muted">Compare multiple extraction methods</small>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Custom Fields Input (Hidden by default) -->
        <div class="row mb-4 d-none" id="custom-fields-section">
            <div class="col-lg-8 mx-auto">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-list me-2"></i>Custom Fields to Extract</h5>
                    </div>
                    <div class="card-body">
                        <textarea class="form-control" id="custom-fields-input" rows="3" 
                                  placeholder="Enter fields to extract (comma-separated)&#10;Example: contract_number, effective_date, total_amount, signature_date"></textarea>
                        <small class="form-text text-muted">Specify the exact field names you want to extract from the document</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Multi-Technique Options (Hidden by default) -->
        <div class="row mb-4 d-none" id="multi-technique-section">
            <div class="col-lg-8 mx-auto">
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0"><i class="fas fa-layer-group me-2"></i>Multi-Technique Analysis Options</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-3">Select extraction techniques to compare and analyze:</p>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="technique-regex" checked>
                                    <label class="form-check-label" for="technique-regex">
                                        <strong>Regex Pattern Matching</strong><br>
                                        <small class="text-muted">Rule-based extraction using patterns</small>
                                    </label>
                                </div>
                                <div class="form-check mt-2">
                                    <input class="form-check-input" type="checkbox" id="technique-nlp" checked>
                                    <label class="form-check-label" for="technique-nlp">
                                        <strong>NLP Entity Recognition</strong><br>
                                        <small class="text-muted">Named entity recognition and parsing</small>
                                    </label>
                                </div>
                                <div class="form-check mt-2">
                                    <input class="form-check-input" type="checkbox" id="technique-fuzzy" checked>
                                    <label class="form-check-label" for="technique-fuzzy">
                                        <strong>Fuzzy String Matching</strong><br>
                                        <small class="text-muted">Approximate string matching techniques</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="technique-proximity" checked>
                                    <label class="form-check-label" for="technique-proximity">
                                        <strong>Keyword Proximity Analysis</strong><br>
                                        <small class="text-muted">Context-based field detection</small>
                                    </label>
                                </div>
                                <div class="form-check mt-2">
                                    <input class="form-check-input" type="checkbox" id="technique-template" checked>
                                    <label class="form-check-label" for="technique-template">
                                        <strong>Template Classification</strong><br>
                                        <small class="text-muted">Document structure analysis</small>
                                    </label>
                                </div>
                                <div class="form-check mt-2">
                                    <input class="form-check-input" type="checkbox" id="technique-confidence">
                                    <label class="form-check-label" for="technique-confidence">
                                        <strong>Confidence Weighted Ensemble</strong><br>
                                        <small class="text-muted">Combine results with confidence scoring</small>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced Processing Options -->
        <div class="row mb-4" id="enhanced-options-section">
            <div class="col-lg-8 mx-auto">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-magic me-2"></i>Enhanced Processing Options</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="extract-tables" checked>
                                    <label class="form-check-label" for="extract-tables">
                                        Extract Tables from PDFs
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="quality-check" checked>
                                    <label class="form-check-label" for="quality-check">
                                        Document Quality Assessment
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="extract-metadata" checked>
                                    <label class="form-check-label" for="extract-metadata">
                                        Comprehensive Metadata Extraction
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="batch-mode">
                                    <label class="form-check-label" for="batch-mode">
                                        Batch Processing Mode
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Document Upload Section -->
        <div class="row mb-5">
            <div class="col-lg-8 mx-auto">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0"><i class="fas fa-upload me-2"></i>Document Upload</h4>
                    </div>
                    <div class="card-body">
                        <div class="upload-area" id="upload-area">
                            <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                            <h5>Drop files here or click to upload</h5>
                            <p class="text-muted">Supports PDF, DOCX, DOC, HTML, TXT, MD files</p>
                            <input type="file" id="file-input" class="d-none" accept=".pdf,.docx,.doc,.html,.htm,.txt,.md" multiple>
                            <button class="btn btn-primary btn-lg" onclick="document.getElementById('file-input').click()">
                                Select Files
                            </button>
                        </div>
                        
                        <div class="mt-3 text-center">
                            <button class="btn btn-success btn-lg" id="process-btn" onclick="processDocuments()" disabled>
                                <i class="fas fa-play me-2"></i>Process Documents
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="results-section" class="d-none">
            <div class="row">
                <div class="col-12">
                    <h3><i class="fas fa-chart-line me-2"></i>Processing Results</h3>
                    <div id="results-container"></div>
                </div>
            </div>
        </div>

        <!-- Features Section -->
        <div class="row mb-5">
            <div class="col-12">
                <h3 class="text-center mb-4">Enhanced Processing Features</h3>
                <div class="row">
                    {% for feature in features %}
                    <div class="col-md-6 col-lg-4 mb-4">
                        <div class="card feature-card h-100">
                            <div class="card-body text-center">
                                <i class="fas fa-magic fa-2x text-primary mb-3"></i>
                                <h5 class="card-title">{{ feature }}</h5>
                                <p class="card-text text-muted">Advanced NLP processing with intelligent pattern recognition</p>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- API Endpoints Section -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4><i class="fas fa-code me-2"></i>Available API Endpoints</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Enhanced Document API (Port 8001)</h6>
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item">
                                        <code>POST /upload-enhanced/</code> - Advanced processing
                                    </li>
                                    <li class="list-group-item">
                                        <code>POST /batch-process/</code> - Multiple documents
                                    </li>
                                    <li class="list-group-item">
                                        <code>GET /processing-stats</code> - Capability info
                                    </li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>Standard API (Port 8000)</h6>
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item">
                                        <code>POST /upload/</code> - Standard processing
                                    </li>
                                    <li class="list-group-item">
                                        <code>POST /extract-custom/</code> - Custom fields
                                    </li>
                                    <li class="list-group-item">
                                        <code>GET /health</code> - Health check
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom JavaScript -->
    <script>
        // File upload handling
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('file-input');
        const resultsSection = document.getElementById('results-section');
        const resultsContainer = document.getElementById('results-container');
        const processBtn = document.getElementById('process-btn');
        let selectedFiles = [];

        // Processing mode handling
        document.querySelectorAll('input[name="processing-mode"]').forEach(radio => {
            radio.addEventListener('change', function() {
                // Hide specific option sections
                document.getElementById('custom-fields-section').classList.add('d-none');
                document.getElementById('multi-technique-section').classList.add('d-none');
                
                // Show relevant options
                if (this.value === 'custom') {
                    document.getElementById('custom-fields-section').classList.remove('d-none');
                } else if (this.value === 'multi-technique') {
                    document.getElementById('multi-technique-section').classList.remove('d-none');
                }
                // Enhanced options are always visible as they apply to all modes
            });
        });

        // Drag and drop functionality
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            handleFileSelection(files);
        });

        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', (e) => {
            handleFileSelection(e.target.files);
        });

        // File selection handling
        function handleFileSelection(files) {
            selectedFiles = Array.from(files);
            if (selectedFiles.length > 0) {
                processBtn.disabled = false;
                uploadArea.innerHTML = `
                    <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                    <h5>${selectedFiles.length} file(s) selected</h5>
                    <p class="text-muted">${selectedFiles.map(f => f.name).join(', ')}</p>
                    <button class="btn btn-outline-primary" onclick="document.getElementById('file-input').click()">
                        Change Files
                    </button>
                `;
            }
        }

        // Main processing function
        async function processDocuments() {
            if (selectedFiles.length === 0) return;

            // Test API connectivity first
            try {
                console.log('Testing API connectivity...');
                const healthResponse = await fetch('http://localhost:8000/health');
                if (!healthResponse.ok) {
                    throw new Error(`Backend API not responding (Status: ${healthResponse.status})`);
                }
                console.log('API connectivity confirmed');
            } catch (error) {
                console.error('API connectivity failed:', error);
                showError(`Cannot connect to backend API. Please ensure the server is running on port 8000.`);
                return;
            }

            const mode = document.querySelector('input[name="processing-mode"]:checked').value;
            
            try {
                showProcessingIndicator();
                
                // Check if enhanced options are enabled
                const useEnhanced = document.getElementById('extract-tables').checked || 
                                  document.getElementById('quality-check').checked || 
                                  document.getElementById('extract-metadata').checked;
                
                switch (mode) {
                    case 'standard':
                        if (useEnhanced) {
                            await processStandardEnhanced();
                        } else {
                            await processStandard();
                        }
                        break;
                    case 'custom':
                        if (useEnhanced) {
                            await processCustomEnhanced();
                        } else {
                            await processCustom();
                        }
                        break;
                    case 'multi-technique':
                        if (useEnhanced) {
                            await processMultiTechniqueEnhanced();
                        } else {
                            await processMultiTechnique();
                        }
                        break;
                }
            } catch (error) {
                console.error('Processing error details:', error);
                showError('Processing failed: ' + error.message);
            }
        }

        // Standard processing
        async function processStandard() {
            const results = [];
            
            for (let file of selectedFiles) {
                try {
                    console.log(`Processing file: ${file.name}, type: ${file.type}, size: ${file.size}`);
                    
                    const formData = new FormData();
                    formData.append('file', file);

                    console.log('Sending request to:', 'http://localhost:8000/upload/');
                    
                    const response = await fetch('http://localhost:8000/upload/', {
                        method: 'POST',
                        body: formData,
                        mode: 'cors'
                    });

                    console.log('Response status:', response.status);
                    console.log('Response headers:', response.headers);

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('Error response:', errorText);
                        throw new Error(`HTTP ${response.status}: ${errorText}`);
                    }

                    const result = await response.json();
                    console.log('Processing result:', result);
                    result.filename = file.name;
                    result.processing_mode = 'Standard';
                    results.push(result);
                } catch (error) {
                    console.error('Processing error for file:', file.name, error);
                    showError(`Failed to process ${file.name}: ${error.message}`);
                    return;
                }
            }
            
            displayStandardResults(results);
        }

        // Custom fields processing
        async function processCustom() {
            const customFields = document.getElementById('custom-fields-input').value.trim();
            if (!customFields) {
                showError('Please specify custom fields to extract');
                return;
            }

            const results = [];
            
            for (let file of selectedFiles) {
                try {
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('fields', customFields);

                    const response = await fetch('http://localhost:8000/extract-custom/', {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    result.filename = file.name;
                    result.processing_mode = 'Custom Fields';
                    results.push(result);
                } catch (error) {
                    console.error('Processing error for file:', file.name, error);
                    showError(`Failed to process ${file.name}: ${error.message}`);
                    return;
                }
            }
            
            displayCustomResults(results);
        }

        // Multi-technique processing
        async function processMultiTechnique() {
            const selectedTechniques = [];
            const techniqueCheckboxes = [
                { id: 'technique-regex', name: 'Regex Pattern Matching' },
                { id: 'technique-nlp', name: 'NLP Entity Recognition' },
                { id: 'technique-fuzzy', name: 'Fuzzy String Matching' },
                { id: 'technique-proximity', name: 'Keyword Proximity Analysis' },
                { id: 'technique-template', name: 'Template Classification' },
                { id: 'technique-confidence', name: 'Confidence Weighted Ensemble' }
            ];

            techniqueCheckboxes.forEach(technique => {
                if (document.getElementById(technique.id).checked) {
                    selectedTechniques.push(technique.name);
                }
            });

            if (selectedTechniques.length === 0) {
                showError('Please select at least one technique for multi-technique analysis');
                return;
            }

            const results = [];
            
            for (let file of selectedFiles) {
                try {
                    // For now, use standard processing but include technique information
                    const formData = new FormData();
                    formData.append('file', file);

                    const response = await fetch('http://localhost:8000/upload/', {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    result.filename = file.name;
                    result.processing_mode = 'Multi-Technique Analysis';
                    result.selected_techniques = selectedTechniques;
                    result.technique_count = selectedTechniques.length;
                    results.push(result);
                } catch (error) {
                    console.error('Processing error for file:', file.name, error);
                    showError(`Failed to process ${file.name}: ${error.message}`);
                    return;
                }
            }
            
            displayMultiTechniqueResults(results);
        }

        // Enhanced versions of processing functions
        async function processStandardEnhanced() {
            const batchMode = document.getElementById('batch-mode').checked;
            
            if (batchMode && selectedFiles.length > 1) {
                await processBatch(selectedFiles, 'http://localhost:8001/batch-process/');
            } else {
                const results = [];
                for (let file of selectedFiles) {
                    const result = await processSingle(file, 'http://localhost:8001/upload-enhanced/');
                    result.processing_mode = 'Standard + Enhanced';
                    results.push(result);
                }
                displayEnhancedResults(results);
            }
        }

        async function processCustomEnhanced() {
            const customFields = document.getElementById('custom-fields-input').value.trim();
            if (!customFields) {
                showError('Please specify custom fields to extract');
                return;
            }

            // Enhanced custom processing would go to enhanced API
            const results = [];
            
            for (let file of selectedFiles) {
                // For now, use standard custom processing
                const formData = new FormData();
                formData.append('file', file);
                formData.append('fields', customFields);

                const response = await fetch('http://localhost:8000/extract-custom/', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                result.filename = file.name;
                result.processing_mode = 'Custom Fields + Enhanced';
                results.push(result);
            }
            
            displayCustomResults(results);
        }

        async function processMultiTechniqueEnhanced() {
            // Combine multi-technique with enhanced processing
            await processMultiTechnique();
        }

        // Enhanced processing
        async function processEnhanced() {
            const batchMode = document.getElementById('batch-mode').checked;
            
            if (batchMode && selectedFiles.length > 1) {
                await processBatch(selectedFiles, 'http://localhost:8001/batch-process/');
            } else {
                const results = [];
                for (let file of selectedFiles) {
                    const result = await processSingle(file, 'http://localhost:8001/upload-enhanced/');
                    results.push(result);
                }
                displayEnhancedResults(results);
            }
        }

        async function processSingle(file, apiUrl) {
            const formData = new FormData();
            formData.append('file', file);

            const response = await fetch(apiUrl, {
                method: 'POST',
                body: formData
            });

            const result = await response.json();
            result.filename = file.name;
            return result;
        }

        async function processBatch(files, apiUrl) {
            const formData = new FormData();
            for (let file of files) {
                formData.append('files', file);
            }

            const response = await fetch(apiUrl, {
                method: 'POST',
                body: formData
            });

            const result = await response.json();
            displayEnhancedBatchResults(result);
        }

        function showProcessingIndicator() {
            resultsContainer.innerHTML = `
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Processing...</span>
                    </div>
                    <p class="mt-2">Processing documents with enhanced engine...</p>
                </div>
            `;
            resultsSection.classList.remove('d-none');
        }

        // Display functions for different processing modes
        function displayStandardResults(results) {
            let html = '<h4><i class="fas fa-chart-bar me-2"></i>Standard Processing Results</h4>';
            
            results.forEach((result, index) => {
                html += `
                    <div class="card mb-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Document: ${result.filename}</h5>
                            <span class="badge bg-primary">${result.processing_mode}</span>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Customer Information</h6>
                                    <ul class="list-unstyled">
                                        <li><strong>Name:</strong> ${result.customer_info?.name || 'Not found'}</li>
                                        <li><strong>SSN:</strong> ${result.customer_info?.ssn || 'Not found'}</li>
                                        <li><strong>DOB:</strong> ${result.customer_info?.date_of_birth || 'Not found'}</li>
                                        <li><strong>Phone:</strong> ${result.customer_info?.phone || 'Not found'}</li>
                                        <li><strong>Email:</strong> ${result.customer_info?.email || 'Not found'}</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6>Policy Information</h6>
                                    <ul class="list-unstyled">
                                        <li><strong>Policy Number:</strong> ${result.policy_info?.policy_number || 'Not found'}</li>
                                        <li><strong>Type:</strong> ${result.policy_info?.policy_type || 'Not found'}</li>
                                        <li><strong>Coverage:</strong> ${result.policy_info?.coverage_amount || 'Not found'}</li>
                                        <li><strong>Premium:</strong> ${result.policy_info?.premium || 'Not found'}</li>
                                        <li><strong>Effective Date:</strong> ${result.policy_info?.effective_date || 'Not found'}</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="mt-3">
                                <div class="d-flex justify-content-between">
                                    <span><strong>Confidence Score:</strong> ${(result.confidence_score * 100).toFixed(1)}%</span>
                                    <span><strong>Processing Time:</strong> ${result.processing_time?.toFixed(2)}s</span>
                                </div>
                                <div class="progress mt-2">
                                    <div class="progress-bar" style="width: ${result.confidence_score * 100}%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            resultsContainer.innerHTML = html;
        }

        function displayCustomResults(results) {
            let html = '<h4><i class="fas fa-list me-2"></i>Custom Fields Extraction Results</h4>';
            
            results.forEach((result, index) => {
                html += `
                    <div class="card mb-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Document: ${result.filename}</h5>
                            <span class="badge bg-info">${result.processing_mode}</span>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Requested Fields</h6>
                                    <ul class="list-unstyled">
                                        ${result.requested_fields?.map(field => `<li>• ${field}</li>`).join('') || '<li>No fields specified</li>'}
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6>Extracted Values</h6>
                                    <ul class="list-unstyled">
                                        ${Object.entries(result.extracted_fields || {}).map(([key, value]) => 
                                            `<li><strong>${key}:</strong> ${value || 'Not found'}</li>`
                                        ).join('')}
                                    </ul>
                                </div>
                            </div>
                            <div class="mt-3">
                                <div class="d-flex justify-content-between">
                                    <span><strong>Confidence Score:</strong> ${(result.confidence_score * 100).toFixed(1)}%</span>
                                    <span><strong>Processing Time:</strong> ${result.processing_time?.toFixed(2)}s</span>
                                </div>
                                <div class="progress mt-2">
                                    <div class="progress-bar bg-info" style="width: ${result.confidence_score * 100}%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            resultsContainer.innerHTML = html;
        }

        function displayMultiTechniqueResults(results) {
            let html = '<h4><i class="fas fa-layer-group me-2"></i>Multi-Technique Analysis Results</h4>';
            
            results.forEach((result, index) => {
                html += `
                    <div class="card mb-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Document: ${result.filename}</h5>
                            <span class="badge bg-warning text-dark">${result.processing_mode}</span>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <h6>Selected Techniques (${result.technique_count})</h6>
                                    <ul class="list-unstyled">
                                        ${result.selected_techniques?.map(technique => `<li>• ${technique}</li>`).join('') || '<li>No techniques selected</li>'}
                                    </ul>
                                </div>
                                <div class="col-md-4">
                                    <h6>Customer Information</h6>
                                    <ul class="list-unstyled">
                                        <li><strong>Name:</strong> ${result.customer_info?.name || 'Not found'}</li>
                                        <li><strong>SSN:</strong> ${result.customer_info?.ssn || 'Not found'}</li>
                                        <li><strong>DOB:</strong> ${result.customer_info?.date_of_birth || 'Not found'}</li>
                                        <li><strong>Phone:</strong> ${result.customer_info?.phone || 'Not found'}</li>
                                    </ul>
                                </div>
                                <div class="col-md-4">
                                    <h6>Policy Information</h6>
                                    <ul class="list-unstyled">
                                        <li><strong>Policy Number:</strong> ${result.policy_info?.policy_number || 'Not found'}</li>
                                        <li><strong>Type:</strong> ${result.policy_info?.policy_type || 'Not found'}</li>
                                        <li><strong>Coverage:</strong> ${result.policy_info?.coverage_amount || 'Not found'}</li>
                                        <li><strong>Premium:</strong> ${result.policy_info?.premium || 'Not found'}</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="mt-3">
                                <div class="d-flex justify-content-between">
                                    <span><strong>Overall Confidence:</strong> ${(result.confidence_score * 100).toFixed(1)}%</span>
                                    <span><strong>Processing Time:</strong> ${result.processing_time?.toFixed(2)}s</span>
                                </div>
                                <div class="progress mt-2">
                                    <div class="progress-bar bg-warning" style="width: ${result.confidence_score * 100}%"></div>
                                </div>
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Results aggregated from ${result.technique_count} analysis techniques
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            resultsContainer.innerHTML = html;
        }

        function displayEnhancedResults(results) {
            let html = '';
            results.forEach((result, index) => {
                const qualityColor = result.quality_score > 0.7 ? 'success' : 
                                   result.quality_score > 0.4 ? 'warning' : 'danger';
                
                html += `
                    <div class="card mb-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Document: ${result.filename || 'Document ' + (index + 1)}</h5>
                            <span class="badge bg-${qualityColor}">Quality: ${(result.quality_score * 100).toFixed(1)}%</span>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Document Info</h6>
                                    <ul class="list-unstyled">
                                        <li><strong>Type:</strong> ${result.document_type.toUpperCase()}</li>
                                        <li><strong>Size:</strong> ${formatFileSize(result.file_size || 0)}</li>
                                        <li><strong>Processing Time:</strong> ${result.processing_time?.toFixed(2) || 0}s</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6>Extracted Content</h6>
                                    <ul class="list-unstyled">
                                        <li><strong>Text Length:</strong> ${result.text_content?.length || 0} chars</li>
                                        <li><strong>Tables Found:</strong> ${result.tables?.length || 0}</li>
                                        <li><strong>Metadata Fields:</strong> ${Object.keys(result.metadata || {}).length}</li>
                                    </ul>
                                </div>
                            </div>
                            
                            ${result.tables && result.tables.length > 0 ? `
                                <div class="mt-3">
                                    <h6>Extracted Tables</h6>
                                    <div class="table-responsive">
                                        <small class="text-muted">Found ${result.tables.length} table(s)</small>
                                    </div>
                                </div>
                            ` : ''}
                            
                            <div class="mt-3">
                                <h6>Text Preview</h6>
                                <div class="bg-light p-3 rounded" style="max-height: 200px; overflow-y: auto;">
                                    <pre class="mb-0">${(result.text_content || '').substring(0, 500)}${(result.text_content || '').length > 500 ? '...' : ''}</pre>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            resultsContainer.innerHTML = html;
        }

        function displayEnhancedBatchResults(batchResult) {
            let html = `
                <div class="card mb-3">
                    <div class="card-header">
                        <h5 class="mb-0">Batch Processing Results</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 class="text-primary">${batchResult.total_files}</h4>
                                    <small>Total Files</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 class="text-success">${batchResult.successful_files}</h4>
                                    <small>Successful</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 class="text-info">${batchResult.total_processing_time?.toFixed(2)}s</h4>
                                    <small>Total Time</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 class="text-warning">${batchResult.batch_id}</h4>
                                    <small>Batch ID</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            batchResult.results?.forEach((file, index) => {
                const statusColor = file.success ? 'success' : 'danger';
                html += `
                    <div class="card mb-2">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">${file.filename}</h6>
                                    <small class="text-muted">${file.document_type?.toUpperCase() || 'Unknown'} • ${file.text_length || 0} characters</small>
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-${statusColor}">${file.success ? 'Success' : 'Failed'}</span>
                                    ${file.success ? `<div><small>${file.processing_time?.toFixed(2)}s • Quality: ${(file.quality_score * 100).toFixed(1)}%</small></div>` : ''}
                                    ${file.error ? `<div><small class="text-danger">${file.error}</small></div>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            resultsContainer.innerHTML = html;
        }

        function showError(message) {
            resultsContainer.innerHTML = `
                <div class="alert alert-danger" role="alert">
                    <h6 class="alert-heading">Processing Error</h6>
                    <p class="mb-0">${message}</p>
                </div>
            `;
            resultsSection.classList.remove('d-none');
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Check API status
        async function checkApiStatus() {
            try {
                const response = await fetch('http://localhost:8001/health-enhanced');
                const status = await response.json();
                document.getElementById('api-status').innerHTML = 
                    '<i class="fas fa-circle me-1"></i>Enhanced API Online';
                document.getElementById('api-status').className = 'badge bg-success';
            } catch (error) {
                document.getElementById('api-status').innerHTML = 
                    '<i class="fas fa-circle me-1"></i>API Offline';
                document.getElementById('api-status').className = 'badge bg-danger';
            }
        }

        // Initialize
        checkApiStatus();
        setInterval(checkApiStatus, 30000); // Check every 30 seconds
    </script>
</body>
</html>